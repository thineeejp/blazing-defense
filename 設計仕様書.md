# BLAZING DEFENSE: 設備士の決断 設計仕様書 (Ver.7.0)

## 1. プロジェクト概要
- コンセプト: 「知識で現場を制圧せよ」。消防設備士試験（乙種4〜6類など）の学習を目的に、縦型グリッドのタワーディフェンス＋クイズで運用判断と法規知識を体験的に学ぶ。
- ターゲット: 消防設備士受験予定者、ビル管・防災の新人、ゲーミフィケーション学習層。

## 2. ゲームシステム
### 2.1 基本ルール
- ジャンル: 縦型グリッドディフェンス（奥行6行固定 / 横幅は難易度依存）。
- **勝利条件（複合型）**:
  - 時間制限: **90秒（5400フレーム）**守り切る
  - **または** 避難目標: ミッション別の避難人数に到達（図書館100人/百貨店300人/化学工場600人）
- 敗北条件: 敵（火災）が防衛ラインを突破するとHP減少。HP<=0で終了。
- リソース: Cost（⚡）= 設置コスト。毎フレーム0.05 + 経済設備の加算で回復。HP=100固定。
- スコアシステム: 最終スコアは避難人数（×100点）を最重視し、時間ボーナス、HP残量、コスト効率、敵撃破を総合評価。特別ボーナス（ノーダメージ、スピードクリア、エコノミー）も加算。

### 2.2 フィールド・難易度
- 行: 6固定（手前が防衛ライン）。
- 列: EASY=3列 / NORMAL=5列 / HARD=7列。
- 防衛ライン: 最下段を突破されるとダメージ演出＋HP減少。
- 表示: 3Dパース風グリッド。上部にDANGER ZONE、最下段にDEFENSE LINE表記。

### 2.3 敵（火災）挙動
- スタッツ（初期サイズ1x1、生成位置 progress=-1 で画面外から出現）  
  - A火災: hp 20 / speed 0.02  
  - B火災(油): hp 40 / speed 0.015  
  - C火災(電気): hp 15 / speed 0.04
- 成長: 進行距離に応じてサイズアップ（3マスで2x2、5マスで3x3）。成長時は中心を維持し、位置ワープなし。
- 移動速度補正: sizeが大きいほど減速（speed / (1 + (size-1)*0.6)）。大きくなっても加速に見えないよう調整。
- 到達判定: 敵中心が最終行を跨ぐ（center >= GRID_ROWS-0.5）と攻撃モードへ。30フレーム残ってBREAKポップアップとHP減少（ダメージ=10×size）。
- ノックバック: ポンプ車のみ全画面押し戻し（progressを負方向へ）。最小値は -1 にクランプ。
- **属性相性**: B火災は**water 0.5倍**/foam 2.0倍、C火災はgas 1.5倍。Hit時にポップアップ表示。
- **出現頻度**: spawnRate = max(30, 難易度初期値 - floor(frame/500))。colはランダム。
- **難易度別出現率（重み付け）**:
  - **EASY**: [A火災 90%, B火災 5%, C火災 5%] - 初心者向け、基本消火訓練
  - **NORMAL**: [A火災 90%, B火災 5%, C火災 5%] - 列数増加でバランス調整
  - **HARD**: [A火災 40%, B火災 35%, C火災 25%] - 特殊火災の知識が必須

## 3. 設備カード
- Range種別: Surround(周囲3x3)、Wide(横1列×縦3)、Line(縦1列正面)、Global(全体)。
- 基本デッキ
  - extinguisher: 10型消火器 / 🔴 cost 30 / Surround / power 2 / speed 40 / water
  - sprinkler: スプリンクラーヘッド / 🔴 cost 90 / Wide / power 1.0 / speed 60 / water
  - alarm: 感知器 / 🟡 cost 25 / 経済 / value +0.6（回復量）
  - exitSign: 誘導灯 / 🟢 cost 50 / 避難 / 避難速度+0.5人/秒
  - rescueChute: 救助袋 / 🟢 cost 80 / 避難 / 避難速度+1.0人/秒
  - fireEngine: ポンプ車 / 🟣 cost 0（召喚） / **Global（全画面）** / power 10 / speed 10 / duration 300f / knockback 1.5 / water
    - **fireNotification（消防機関通報設備）から10秒後に変身して召喚される特殊カード**
- 特効報酬（Phase1正解でミッション固有カードを追加）  
  - gasSystem: 不活性ガス / 🔴 cost 70 / Global / power 0.3 / speed 5 / gas  
  - foamHead: 泡消火ヘッド / 🔴 cost 100 / Surround / power 20 / speed 80 / foam  
  - superSmoke: 光電式分離型感知器 / 🟡 cost 40 / 経済 / value +1.5

## 4. 学習フェーズとフロー（v2.0 - BRIEFINGシステム）

### 4.1 MENU
- ミッション選択（EASY:図書館 / NORMAL:百貨店 / HARD:化学工場）
- 難易度は列数/初期スポーンレート/避難目標に反映
- 初回起動時は3Dグリッド＋ブートアニメーション演出

### 4.2 BRIEFING（Tier強化システム）
**3ラウンド制のクイズ形式**で、カテゴリごとのTierを段階的に解放：

- **ラウンド構成**: Round 1 → Round 2 → Round 3（各ラウンド5問）
- **出題方式**: 5カテゴリ（消火/警報/避難/施設/その他）からランダムに1問ずつ出題
- **クイズプール**: 各カテゴリ10問×5カテゴリ = 計50問
- **Tierシステム**:
  - 正解するとそのカテゴリのTierが+1上昇（Tier1 → Tier2 → Tier3）
  - Tier3到達後も正解するとTier4, 5...と上昇（オーバーフロー）
- **オーバーフロー報酬**（Tier4以降）:
  - コスト割引: -10%/Tier（最大累積）
  - 攻撃力バフ: +15%/Tier（最大累積）
- **コスト報酬**: 正解1問につき初期コスト+40（最大15問 = +600コスト）

### 4.3 DECK_BUILD（デッキ構築フェーズ）
**獲得したTierに応じて利用可能なカードからデッキを構築**：

- **利用可能カード**: 各カテゴリのTier以下のカード（Tier1～獲得Tier）
- **選択上限**: 最大6枚
- **選択コスト**: Tier1カードは無料、Tier2以降はカード本来のコストを消費
- **残りコスト**: BRIEFINGで獲得したコストから選択コストを差し引き、残りを戦闘開始時の初期コストとする
- **戦略性**: 高Tierカードを多く選ぶと初期コストが少なくなるトレードオフ

### 4.4 BATTLE
- **カード配置**: デッキから選択してグリッドに配置
  - **連続配置機能**: カード配置後も選択状態を維持し、同じカードを連続で複数箇所に配置可能
  - コスト回復: 毎フレーム0.05 + 経済設備の加算
  - 撃破報酬: 敵撃破でコスト+15
- **避難システム**: 基本速度1人/秒で自動的に避難人数が増加。green系タワー（避難設備）で加速。
- **勝利条件**: **90秒守り切る**、または目標避難人数に到達で「MISSION COMPLETE」。
- **敗北条件**: 防衛ライン突破でHP減少、HP0で「GAME OVER」。
- **最終スコア**: 避難人数×100点を基本に、時間・HP・コスト・撃破数で総合評価。

### 4.5 GAMEOVER
- 勝利/敗北の判定結果とスコア内訳を表示
- スコア内訳: 避難、時間、HP、コスト、撃破、特別ボーナス
- リトライ or メニューへ戻る

## 5. UI/UX
- **HUD**: 上部にHP(%)、Cost、避難人数（現在数/目標数）を表示。右上に残り時間を表示。ダメージ時は赤フラッシュ＋揺れ。
- **フィールド**: パース付きグリッド。敵は炎アイコン、攻撃時はドクロ。HPバー表示。
- **デッキ**: 下部横スクロール。コスト不足でグレーアウト。選択中は浮き上がり。
  - **連続配置**: カード配置後も選択状態を維持（同じカードを連続配置可能）
- **フィードバック**: Hit/特効/減衰ポップアップ、設置時「設置」、攻撃到達時「BREAK!-xx」。
- **グラスモーフィズムUI**: backdrop-blur、半透明背景、シマー効果による近未来的なデザイン

## 6. 技術スタック
- React 18（Hooks）、Vite、Tailwind CSS、lucide-reactアイコン。
- アニメーション: requestAnimationFrame 60fpsループ。
- 単一HTMLでのビルド配信を想定（GitHub Pages等）。

## 7. コードアーキテクチャ

### 7.1 プロジェクト構造（v2.0 + Phase 8-11拡張）
```
src/
├── components/
│   ├── Menu.jsx              (~30行)   - メニュー画面
│   ├── BriefingPhase.jsx     (~200行)  - Tier強化システム（3ラウンドクイズ）
│   ├── DeckBuildPhase.jsx    (~150行)  - デッキ構築画面
│   ├── BattleField.jsx       (~270行)  - バトル画面
│   ├── GameOver.jsx          (~350行)  - ゲームオーバー画面（Phase 10-11で大幅拡張）
│   ├── HighScores.jsx        (~150行)  - ハイスコアランキング画面（Phase 9）
│   ├── Achievements.jsx      (~200行)  - 実績画面UI（Phase 8）
│   ├── Gallery.jsx           (~100行)  - ギャラリー画面（実績・ハイスコア統合）（Phase 8）
│   └── ui/
│       ├── GameBackground.jsx (~40行) - 3Dグリッド背景コンポーネント
│       └── GlassCard.jsx      (~25行) - グラスモーフィズムカードコンポーネント
├── constants/
│   ├── cards.js              (~370行)  - 全22種類のカード定義
│   ├── equipment.js          (~80行)   - Tierシステム・オーバーフロー報酬定義
│   ├── quizzes.js            (~250行)  - クイズ問題プール（5種別×10問=50問）
│   ├── achievements.js       (~100行)  - 実績定義（9種類）（Phase 8）
│   └── game.js               (~10行)   - ゲーム定数（MAX_COST等）（Phase 9）
├── utils/
│   ├── achievements.js       (~200行)  - 実績ロジック（解除判定、統計追跡）（Phase 8）
│   └── highScores.js         (~100行)  - ハイスコア保存・読み込み・ソート処理（Phase 9）
├── App.jsx                   (~960行)  - メインロジックと状態管理
├── main.jsx                  - Reactアプリケーションのエントリーポイント
└── index.css                 - グローバルスタイル（Tailwindディレクティブ含む）
```

### 7.2 状態管理設計（v2.0）
- **App.jsx**: すべてのゲーム状態とロジックを一元管理（~960行）
  - ゲーム状態: hp, cost, evacuatedCount, towers, enemies, effects等
  - BRIEFINGシステム: briefingState（tiers, round, categoryBuffs等）
  - DECK_BUILDシステム: deckBuildState（selectedCardIds, remainingCost）
  - ゲームロジック: スポーン、戦闘、攻撃判定、13種類のeffect処理
  - Tierシステム、オーバーフロー報酬、変身/DoT/スロー/バフ等の特殊効果
- **コンポーネント**: Propsベースの純粋なUIコンポーネント
- **定数ファイル**: `src/constants/`で分離管理（cards.js, equipment.js, quizzes.js）
- **ゲームループ**: `requestAnimationFrame`で60FPSのゲームロジック更新
- **Refs使用**: `towersRef`, `difficultyRef`でクロージャ問題を回避

**App.jsx再拡大の理由**:
- Phase 4でBRIEFINGシステム導入により560行→~960行に増加
- 13種類のeffect処理、Tier管理、オーバーフロー報酬、特殊効果ロジックの追加
- 小規模ゲームのためRedux/Zustand等の状態管理ライブラリは不要と判断
- 将来的にはカスタムフック分離（useGameLoop, useEffects等）を検討

### 7.3 コード品質保証
- **ESLint**: React/JSX推奨設定で静的解析（エラー0、警告0）
- **安全ガード**: NaN/Infinite対策、0除算防止
- **非ブロッキングUI**: window.confirm廃止、カスタムモーダル採用
- **ビルド最適化**: Viteによる高速ビルド（~5.0秒、205.40kB gzipped 66.45kB）
- **LocalStorage**: ハイスコア・実績データの永続化（`blazingDefense_*`キー）

### 7.4 開発履歴

#### Phase 1: コード品質改善（緊急修正）
**実施日**: 2025-11-26
**コミット**: ae703ca

- ESLint設定追加（`.eslintrc.json`, `.eslintignore`）
- `window.confirm` → 非ブロッキングモーダルに置き換え
- `sizeSlow`安全ガード追加（0除算/NaN防止）
- Reactインポート最適化（JSX変換で不要なReactを削除）

**効果**: lint/buildエラー0、警告0達成

#### Phase 2: コンポーネント分割（Menu/Draft/Exam/GameOver）
**実施日**: 2025-11-26
**コミット**: 36328bc

**新規コンポーネント**:
- `Menu.jsx`: ミッション選択画面
- `GameOver.jsx`: ゲームオーバー画面
- `DraftPhase.jsx`: 現場診断フェーズ（lucide-reactアイコン含む）
- `ExamPhase.jsx`: 予算獲得試験フェーズ

**効果**:
- App.jsx: 922行 → 780行（-15%削減）
- コンポーネント数: 1 → 5
- 各画面の責務が明確化

#### Phase 3: BattleFieldコンポーネント分割（完了）
**実施日**: 2025-11-26
**コミット**: 13625ba

**新規コンポーネント**:
- `BattleField.jsx`: バトル画面全体（~240行）
  - グリッド、敵、タワー、エフェクト、デッキ、モーダルを含む
  - `RANGE_LABEL`, `GRID_ROWS`を内部定義

**効果**:
- App.jsx: 780行 → 560行（累計-39%削減）
- 最大ファイル行数: 922行 → 560行
- 保守性・テスタビリティの大幅向上

#### Phase 4: 勝利条件とスコアシステムの刷新
**実施日**: 2025-11-28
**コミット**: f4eda77

**主な変更**:
1. **勝利条件の追加（複合型）**
   - 時間制限: 3分（10800フレーム）守り切ったら勝利
   - または避難達成: ミッション別の目標人数（100/300/600人）に到達で勝利
   - 勝利時は「MISSION COMPLETE!」画面へ移行

2. **避難システムの実装**
   - 新規状態変数: `evacuatedCount`, `evacuationGoal`, `timeLimit`, `clearTime`, `defeatedEnemies`
   - 基本避難速度: 1人/秒（60フレームごとに自動加算）
   - green系タワーで避難速度を加速:
     - `exitSign`（誘導灯）: +0.5人/秒
     - `rescueChute`（救助袋・新カード）: +1.0人/秒

3. **スコアシステムの刷新**
   - `calculateFinalScore()`関数を実装
   - 避難人数×100点を最重視（戦略性の向上）
   - 時間ボーナス、HP残量、コスト効率、敵撃破を総合評価
   - 特別ボーナス: ノーダメージ（+2000点）、スピードクリア（+1000点）、エコノミー（+500点）

4. **UI/UX の改善**
   - BattleFieldヘッダーに避難カウンター（現在数/目標数）と残り時間を表示
   - GameOverコンポーネントを再設計し、勝利/敗北両対応に
   - スコア内訳を詳細表示（避難、時間、HP、コスト、撃破、特別ボーナス）

5. **コード最適化**
   - green系タワーのスコア加算処理を削除（避難速度のみに影響）
   - `score`状態変数を削除（最終計算のみで使用）
   - `DRAFT_MISSIONS`に`evacuationGoal`プロパティを追加

**効果**:
- ゲームシステム: エンドレス型 → 目標達成型へ進化
- 戦略性の向上: 避難設備の重要性が増し、時間とリソースのバランスが重要に
- 教育性の強化: 避難誘導の重要性を体験的に学習
- ビルド: 171.19 kB（gzip: 56.90 kB）
- ESLint: エラー0、警告0達成

#### Phase 5: バグ修正（レビュー指摘対応）
**実施日**: 2025-11-30
**コミット**: 32749de

**修正内容**:
1. **アイコン描画修正**（BattleField.jsx）
   - 問題: `{tower.card.icon}` が関数参照のまま表示される
   - 修正: `React.createElement(tower.card.icon, { size: 24 })` に変更
   - 対象: グリッド内タワー表示、デッキカード表示

2. **攻撃可能カード判定修正**（App.jsx）
   - 問題: purple系カードがすべて攻撃処理され、power未定義でNaNダメージ発生
   - 修正: `t.card.power !== undefined && t.card.power > 0` で攻撃可能カードを限定
   - 効果: 支援系カード（fireDoor、emergencyElevator等）が正常動作

3. **effect処理完全実装**（App.jsx updateBattleLogic）
   - 問題: `effect === 'economy'` のみ処理され、他12種類が未実装
   - 修正: 全13種類のeffectをswitch-caseで完全実装
   - 対象effect:
     - economy, economyAndEvacuation, economyWithTransform
     - evacuation, evacuationWithRegen, evacuationWithRegenAndBuff
     - buffPower, globalSpeedBuffWithRegen, globalSlowWithEvacuation
     - rowBlockTimed, firefighterSupport, areaDotWithSlow, ultimateBuff

4. **特殊効果ロジック実装**（App.jsx）
   - fireNotification変身処理: 10秒後にポンプ車へ変身
   - fireDoor横1列停止: 敵の中心位置判定でブロック
   - packageFireSystemのDoT+スロー: 周囲3x3に毎秒ダメージ＋減速
   - smokeControl全敵減速: globalSlowDebuffを敵速度に適用
   - standpipe周囲バフ: 攻撃力+30%をfireAttack内で計算
   - emergencyElevatorコスト割引: グローバル割引をUI反映

**効果**:
- 全22種類のカードが仕様通り動作
- ビルド: 187.75 kB（gzip: 62.40 kB）
- ESLint: エラー0、警告0達成

#### Phase 6: セルフレビュー対応（データ定義の整合性修正）
**実施日**: 2025-11-30
**コミット**: aac03a7

**修正内容**:
1. **fireNotificationのduration未定義を修正**（cards.js）
   - 問題: durationプロパティが省略されており、消滅判定が不正
   - 修正: `duration: null` を明示（永続・変身まで残る）
   - 仕様: 変身前は永続でコスト回復、10秒後にポンプ車（5秒間）に変身

2. **autoFireAlarmのearlyWarning削除**（cards.js）
   - 問題: `earlyWarning: true` が定義されているが未実装
   - 修正: プロパティを削除（将来実装を検討）
   - 説明文「敵感知警告」は残し、演出的な表現として維持

**効果**:
- カードデータの整合性が向上
- ビルド: 187.75 kB（gzip: 62.40 kB）
- ESLint: エラー0、警告0達成

#### Phase 7: UX改善とゲームバランス調整（ポンプ車強化＋連続配置）
**実施日**: 2025-12-03
**コミット**: 7d8e806

**主要な変更**:
1. **ポンプ車の効果強化**（cards.js:355-356）
   - 問題: ポンプ車の効果（縦1列制圧）が5秒間という短時間に対して弱すぎる
   - 修正: `rangeType: 'line'` → `rangeType: 'global'`（全画面攻撃に変更）
   - 説明: 「縦1列を5秒間制圧」→「全敵を5秒間制圧」
   - 効果: 短時間でも全画面の敵を制圧できる強力なフィニッシャーに

2. **カード連続配置機能**（App.jsx:640）
   - 問題: カード配置後に選択が解除され、同じカードを連続配置できない
   - 修正: `setSelectedCard(null);` を削除し、選択状態を維持
   - 効果: 同じカードを連続で複数箇所に配置可能（UX向上）

**ゲームバランス調整（前回セッションからの累積）**:
3. **B火災の水倍率向上**（App.jsx:530）
   - 修正: 0.1倍 → **0.5倍**（5倍に緩和）
   - 効果: 水系カードがB火災（油火災）にもある程度有効に

4. **敵出現率の難易度別調整**（App.jsx:430-474）
   - **EASY**: [A火災 90%, B火災 5%, C火災 5%] - 初心者向け
   - **NORMAL**: [A火災 90%, B火災 5%, C火災 5%] - 列数増加でバランス
   - **HARD**: [A火災 40%, B火災 35%, C火災 25%] - 特殊火災の知識必須
   - 効果: 初心者が基本を学びやすく、上級者は特殊火災対応を要求される

5. **補給システムの削除**
   - 削除対象: 補給ボタン、補給モーダル、補給クールダウン、SUPPLY_QUESTIONS等
   - 理由: ゲームフローの簡素化、BRIEFINGシステムに集中
   - 効果: 戦闘中の中断が減り、テンポの良いゲームプレイに

6. **時間制限の短縮**（App.jsx:123）
   - 修正: 180秒（10800フレーム）→ **90秒（5400フレーム）**
   - 効果: よりテンポの速い戦闘、緊張感の向上

7. **カード持続時間の調整**（cards.js）
   - 全15カードの持続時間を約半減（5秒以下と永続は除外）
   - 45秒 → 25秒（extinguisher, inertGasSystem）
   - 60秒 → 30秒（emergencyBell, foamSystem, packageFireSystem）
   - 90秒 → 45秒（indoorHydrant, autoFireAlarm, rescueChute, smokeControl, compactFireAlarm）
   - 120秒 → 60秒（sprinkler, broadcastSystem, descentDevice, emergencyOutlet, disasterControlCenter）
   - 効果: 90秒の戦闘時間に合わせた適切なバランス

**効果**:
- ゲームバランス: 初心者向けの難易度調整と上級者向けの戦略性向上
- UX向上: 連続配置機能による快適な操作感
- ポンプ車の強化: 短時間でも全画面制圧可能な強力カードに
- ビルド: 205.40 kB（gzip: 66.45 kB）、5.08秒
- ESLint: エラー0、警告0達成

#### Phase 8: 実績システムの実装とバグ修正
**実施日**: 2025-12-04
**コミット**: acfaf6b

**主要な変更**:
1. **実績システムの実装**
   - 新規ファイル作成:
     - `src/constants/achievements.js`: 実績定義（9種類）
     - `src/utils/achievements.js`: 実績ロジック（解除判定、統計追跡）
     - `src/components/Achievements.jsx`: 実績画面UI
     - `src/components/Gallery.jsx`: ギャラリー画面（実績・ハイスコア統合）
   - 実績種類:
     - 初勝利、全難易度制覇、ノーダメージ、スピードクリア
     - 完全避難、エコノミー、全カード使用、大量撃破、コンプリート

2. **累計使用カード追跡システム**（LocalStorage拡張）
   - `usedCardIds`配列で全ゲームプレイを通じて使用したカードを記録
   - デッキ構築時に累積カウント
   - 全21種類使用で「コンプリート」実績解除（fireEngine除外）

**バグ修正内容**:
1. **全難易度制覇が最後の難易度クリア時に解除されない問題**
   - 原因: 統計更新前に判定していたため、現在の勝利がカウントされない
   - 修正: 現在の難易度クリアを判定ロジックに含める

2. **コンプリート実績が達成不可能だった問題**
   - 原因: デッキ6枚制限なのに22種要求（ALL_CARDS.length undefined）
   - 修正: 累計使用カード追跡システム実装（LocalStorage拡張）
   - 修正: fireEngine除外（21種類に変更、デッキ構築不可のため）

3. **analyzeDeck の ALL_CARDS.length バグ**
   - 原因: ALL_CARDSはオブジェクトなので length は undefined
   - 修正: `Object.keys(ALL_CARDS).filter(id => id !== 'fireEngine').length`

4. **trackUsedCards の deck 型バグ**
   - 原因: deckをオブジェクトで渡しているのに配列として処理
   - 修正: `Array.isArray()` で判定して `Object.values()` で変換

5. **fireEngine 除外漏れ**
   - 原因: fireEngineはデッキ構築で選択不可だが22種カウントに含まれていた
   - 修正: 実績判定から除外（21種類に変更）

**効果**:
- プレイヤーのモチベーション向上（実績コンプリート要素）
- 長期的なゲーム目標の提供
- バグ0、正常動作
- ビルド: 174.87 kB（gzip: 58.49 kB）、4.96秒
- ESLint: エラー0、警告0達成

#### Phase 9: コスト上限拡大とハイスコアランキング機能
**実施日**: 2025-12-04
**コミット**: 3e5c929

**主要な変更**:
1. **コスト上限を999→9999に変更**
   - 新規ファイル: `src/constants/game.js`（`MAX_COST = 9999`定義）
   - App.jsx: コスト回復処理と敵撃破時の加算に上限適用
   - 理由: 長期戦でのリソース管理の幅を広げ、エコノミー実績（777以上）の達成率向上

2. **ハイスコアランキング機能**
   - 新規ファイル:
     - `src/utils/highScores.js`: ハイスコア保存・読み込み・ソート処理
     - `src/components/HighScores.jsx`: ハイスコア画面UI
   - トップ3ランキング（全難易度統合）
   - LocalStorage保存（`blazingDefense_highScores`キー）
   - ランキング情報:
     - 順位バッジ（1位：金、2位：銀、3位：銅）
     - 統計情報表示（避難人数、HP、タイムボーナス、撃破数）
     - 使用カード表示（最大6枚、アイコン付き）
   - MENU画面にHIGH SCORESボタン追加
   - GameOver画面でNEW HIGH SCORE表示（トップ3入賞時）

**バグ修正内容**:
- **GameOver.jsx React.StrictModeでのハイスコア重複登録**
  - 原因: React.StrictModeで2回レンダリングされる
  - 修正: `useRef`で重複保存防止フラグ追加

**効果**:
- ハイスコア競争によるリプレイ性向上
- コスト上限拡大でエコノミー実績の達成率向上
- スコアアタック要素の追加
- ビルド: 205.40 kB（gzip: 66.45 kB）、5.08秒
- ESLint: エラー0、警告0達成

#### Phase 10: リザルト画面の大規模改善（バッジ倍率システム）
**実施日**: 2025-12-06

**主要な変更**:
1. **避難目標達成バグ修正**（App.jsx）
   - 問題: Reactの非同期状態更新により、避難目標達成時に即座に勝利判定されない
   - 修正: `evacuatedCountRef`を導入して最新値を同期的に参照
   - 効果: 避難人数が目標達成した瞬間にMISSION COMPLETE

2. **RETRYボタン実装**（App.jsx, GameOver.jsx）
   - 問題: 両方のボタンがメニューに戻る動作
   - 修正: `handleRetry`関数を追加してBRIEFINGフェーズから再スタート
   - 効果: 同じ難易度で即座にリトライ可能

3. **ECONOMY RUNバッジ追加**（App.jsx, GameOver.jsx）
   - 条件: コスト777以上で勝利
   - 色: 緑色（green-500/20）
   - 効果: エコノミープレイの達成感向上

4. **残りコスト表示追加**（GameOver.jsx）
   - リザルト画面の4列グリッドに「REMAINING COST」を追加
   - アイコン: Coins（lucide-react）

5. **バッジシステムの倍率化**（App.jsx, GameOver.jsx）
   - **変更前**: 固定ボーナス（NO DAMAGE +2000、SPEED RUN +1000、ECONOMY +500）
   - **変更後**: 基礎スコア × バッジ倍率方式（各バッジ ×1.1）
   - バッジ種類:
     - NO DAMAGE（HP 100%）: ×1.1
     - SPEED RUN（時間半分以下）: ×1.1
     - ECONOMY RUN（コスト777以上）: ×1.1
   - 倍率の積算: 3つ獲得で ×1.331
   - UI改善: バッジセクションで各バッジの倍率を明示表示

6. **レイアウト刷新**（GameOver.jsx）
   - Total Score上部配置（大きく表示、光るエフェクト）
   - 4列グリッド（避難人数、タイムボーナス、HP、残りコスト）
   - バッジセクション（各バッジの倍率効果を視覚化）
   - 合計倍率表示（Total Multiplier: ×1.331）

7. **オペレーターカード削除と中央配置**（GameOver.jsx）
   - 変更: 左側のキャラクターカード（OPERATOR YAMADA）を削除
   - レイアウト: `flex flex-row` → `flex flex-col items-center`
   - 幅: `max-w-5xl` → `max-w-3xl`
   - 効果: スコア関係を中央に配置、シンプルで見やすいデザイン

8. **残り時間表示**（GameOver.jsx）
   - **変更前**: TIME BONUS（ボーナス点数）
   - **変更後**: REMAINING TIME（残り時間を秒で表示）
   - 計算: `(timeLimit - clearTime) / 60` 秒
   - 表示形式: "45s"

9. **タイムボーナス計算変更**（App.jsx）
   - **変更前**: `(timeLimit - clearTime) * 10`
   - **変更後**: `(timeLimit - clearTime) * 5`
   - 効果: バッジ倍率方式とのバランス調整

10. **SPEED RUNバッジ廃止 → EVACUATION COMPLETEバッジ**（App.jsx, GameOver.jsx）
    - **削除**: SPEED RUN（`clearTime <= timeLimit / 2`）
    - **追加**: EVACUATION COMPLETE（`evacuatedCount >= evacuationGoal`）
    - アイコン: 🚪
    - 色: text-green-300（緑色）
    - 条件: 勝利時は常にtrue（避難目標達成が勝利条件のため）

11. **バッジ倍率強化**（App.jsx, GameOver.jsx）
    - **変更前**: 各バッジ ×1.1（3つで ×1.331）
    - **変更後**: 各バッジ ×1.2（3つで ×1.728）
    - 効果: バッジ獲得の達成感とスコアへの影響力が向上

**新しいバッジシステム**:
| バッジ名 | アイコン | 条件 | 倍率 | 色 |
|---|---|---|---|---|
| NO DAMAGE | 🏅 | HP = 100% | ×1.2 | green-300 |
| EVACUATION COMPLETE | 🚪 | 避難目標達成 | ×1.2 | green-300 |
| ECONOMY RUN | 💎 | コスト≥777 | ×1.2 | green-300 |

**スコア計算の変更**:
```javascript
// 変更前
totalScore = baseScore + noDamageBonus(+2000) + speedBonus(+1000) + economyBonus(+500)

// 変更後
baseScore = evacuationScore + timeBonus + hpBonus + costBonus + defeatBonus
multiplier = 1.0
if (hasNoDamageBadge) multiplier *= 1.2
if (hasEvacuationBadge) multiplier *= 1.2
if (hasEconomyBadge) multiplier *= 1.2
totalScore = Math.floor(baseScore * multiplier)
```

**効果**:
- バッジの価値向上: 基礎スコアに応じて倍率が効くため、ハイスコア時により大きな差が生まれる
- 戦略性の向上: 高基礎スコア + バッジ獲得の両立が重要に
- UI/UXの大幅改善: バッジの効果が可視化され、達成感が向上
- リトライ性の向上: RETRYボタンでBRIEFINGから即座に再挑戦可能

#### Phase 11: バッジ色の改善とギャラリー表示の統一
**実施日**: 2025-12-06

**主要な変更**:
1. **バッジの色変更**（GameOver.jsx）
   - 問題: EVACUATION COMPLETEとECONOMY RUNが同じ緑色で区別しにくい
   - 修正:
     - **NO DAMAGE**: yellow-300 → **cyan-300（シアン）** - 冷静・防御のイメージ
     - **EVACUATION COMPLETE**: **green-300（緑）** - 避難成功のイメージ（変更なし）
     - **ECONOMY RUN**: green-300 → **amber-300（アンバー）** - コスト・富のイメージ
   - 効果: 各バッジが明確に区別でき、視覚的な識別性が向上

2. **ギャラリーのハイスコア表示変更**（HighScores.jsx）
   - 問題: ギャラリーとリザルト画面の表示項目が不一致
   - 修正:
     - **Time Bonus** → **Remaining Time**（残り時間を秒で表示）
     - **Defeated** → **Remaining Cost**（残りコスト表示）
     - アイコン追加: `Coins`（lucide-react）
   - 効果: リザルト画面とギャラリーの表示形式が統一され、一貫性が向上

**新しいバッジシステム（Phase 11）**:
| バッジ名 | アイコン | 条件 | 倍率 | 色 |
|---|---|---|---|---|
| NO DAMAGE | 🏅 | HP = 100% | ×1.2 | **cyan-300（シアン）** |
| EVACUATION COMPLETE | 🚪 | 避難目標達成 | ×1.2 | green-300（緑） |
| ECONOMY RUN | 💎 | コスト≥777 | ×1.2 | **amber-300（アンバー）** |

**ギャラリー表示内容（Phase 11）**:
```
Evacuated | HP | Remaining Time | Remaining Cost
100/300   | 75%| 20s            | 777
```

**効果**:
- バッジの視覚的識別性向上: 3色（シアン・緑・アンバー）で明確に区別
- UI一貫性の向上: リザルト画面とギャラリーの表示形式が統一
- ユーザー体験の改善: 情報の一貫性により理解しやすい

### 7.5 設計判断の記録

#### モノリシック状態管理の維持
**理由**: 小規模ゲームのため、Redux/Zustand等の状態管理ライブラリは導入せず、App.jsxで一元管理。

**利点**:
- シンプルな依存関係
- データフローが追いやすい
- オーバーヘッドなし

**欠点**:
- Props Drillingが深い（BattleFieldで20個のprops）
- 将来的な規模拡大時は状態管理ライブラリ検討が必要

#### コンポーネント分割基準
- **画面単位**: 各フェーズ（MENU/DRAFT/EXAM/BATTLE/GAMEOVER）を独立コンポーネント化
- **粒度**: 画面レベルまでで止め、過度な細分化は避ける
- **再利用性**: より汎用的なUIコンポーネント（ボタン、カード等）は現時点では未分割

## 8. 今後の拡張案

### ゲームプレイ拡張
- 状態異常: 煙による視界不良、注水によるクリア後評価減点
- 鑑別モード: 画像から器具名を答える実技対策ミニゲーム
- 編成/ガチャ: 報酬カードの収集とデッキ編成
- マルチライン/階層追加: 2F,3Fなどを増やし、延焼ルートを立体化

### 技術的改善
- **TypeScript移行**: 型安全性の向上（特にcard定義、effect処理の型安全化）
- **状態管理ライブラリ**: Zustand/Jotai等でProps Drilling解消（BattleFieldの25個以上のprops対策）
- **カスタムフック**: `useGameLoop`, `useEnemies`, `useTowers`, `useEffects`への分離でApp.jsx簡素化
- ~~**定数ファイル分離**~~: ✅ **実装済み**（`constants/cards.js`, `equipment.js`, `quizzes.js`）
- **ユニットテスト**: Vitest導入でゲームロジックのテスト（effect処理、攻撃判定、勝利条件等）
- **パフォーマンス最適化**: React.memo、useMemo、useCallbackの適用（特にBattleFieldのレンダリング最適化）
- **エラーハンドリング強化**: カード定義の不整合検出、effectタイプの未実装検出
- **デバッグツール**: 開発モード時のゲーム状態可視化、タワー効果の詳細表示
