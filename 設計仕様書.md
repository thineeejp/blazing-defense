# BLAZING DEFENSE: 設備士の決断 設計仕様書 (Ver.4.4)

## 1. プロジェクト概要
- コンセプト: 「知識で現場を制圧せよ」。消防設備士試験（乙種4〜6類など）の学習を目的に、縦型グリッドのタワーディフェンス＋クイズで運用判断と法規知識を体験的に学ぶ。
- ターゲット: 消防設備士受験予定者、ビル管・防災の新人、ゲーミフィケーション学習層。

## 2. ゲームシステム
### 2.1 基本ルール
- ジャンル: 縦型グリッドディフェンス（奥行6行固定 / 横幅は難易度依存）。
- 勝利/終了: 明示的な勝利条件は未設定（エンドレススコア型）。建物HPが0でゲームオーバー。
- 敗北条件: 敵（火災）が防衛ラインを突破するとHP減少。HP<=0で終了。
- リソース: Cost（⚡）= 設置コスト。毎フレーム0.05 + 経済設備の加算で回復。HP=100固定。Score=撃破と救助で加点。

### 2.2 フィールド・難易度
- 行: 6固定（手前が防衛ライン）。
- 列: EASY=3列 / NORMAL=5列 / HARD=7列。
- 防衛ライン: 最下段を突破されるとダメージ演出＋HP減少。
- 表示: 3Dパース風グリッド。上部にDANGER ZONE、最下段にDEFENSE LINE表記。

### 2.3 敵（火災）挙動
- スタッツ（初期サイズ1x1、生成位置 progress=-1 で画面外から出現）  
  - A火災: hp 20 / speed 0.02  
  - B火災(油): hp 40 / speed 0.015  
  - C火災(電気): hp 15 / speed 0.04
- 成長: 進行距離に応じてサイズアップ（3マスで2x2、5マスで3x3）。成長時は中心を維持し、位置ワープなし。
- 移動速度補正: sizeが大きいほど減速（speed / (1 + (size-1)*0.6)）。大きくなっても加速に見えないよう調整。
- 到達判定: 敵中心が最終行を跨ぐ（center >= GRID_ROWS-0.5）と攻撃モードへ。30フレーム残ってBREAKポップアップとHP減少（ダメージ=10×size）。
- ノックバック: ポンプ車のみ縦列押し戻し（progressを負方向へ）。最小値は -1 にクランプ。
- 属性相性: B火災はwater 0.1倍/foam 2.0倍、C火災はgas 1.5倍。Hit時にポップアップ表示。
- 出現頻度: spawnRate = max(30, 難易度初期値 - floor(frame/500))。colはランダム。

## 3. 設備カード
- Range種別: Surround(周囲3x3)、Wide(横1列×縦3)、Line(縦1列正面)、Global(全体)。
- 基本デッキ  
  - extinguisher: 10型消火器 / 🔴 cost 30 / Surround / power 2 / speed 40 / water  
  - sprinkler: スプリンクラーヘッド / 🔴 cost 90 / Wide / power 1.0 / speed 60 / water  
  - alarm: 感知器 / 🟡 cost 25 / 経済 / value +0.6（回復量）  
  - exitSign: 誘導灯 / 🟢 cost 50 / スコア源 / +20点を60f毎  
  - fireEngine: ポンプ車 / 🟣 cost 200 / Line / power 10 / speed 10 / duration 300f / knockback 1.5 / water
- 特効報酬（Phase1正解でミッション固有カードを追加）  
  - gasSystem: 不活性ガス / 🔴 cost 70 / Global / power 0.3 / speed 5 / gas  
  - foamHead: 泡消火ヘッド / 🔴 cost 100 / Surround / power 20 / speed 80 / foam  
  - superSmoke: 光電式分離型感知器 / 🟡 cost 40 / 経済 / value +1.5

## 4. 学習フェーズとフロー
1. MENU: ミッション選択（EASY:図書館 / NORMAL:百貨店 / HARD:化学工場）。難易度=列数/初期スポーンレートに反映。
2. Phase 1 Draft: 用途適合クイズ（1問）。正解で特効カード1枚付与。不正解は基本デッキのみ。
3. Phase 2 Exam: ○×5問。正解1問につき初期コスト+40。満点で初期200、0点で100。
4. Phase 3 Battle: コスト回復しながらカード設置。撃破でコスト+15、スコア+100。防衛ライン突破でHP減少。HP0でGAME OVER。
5. 緊急補給（任意発動・CD 300f）: 3択クイズ。正解でコスト+150、不正解でクールダウンのみ。

## 5. UI/UX
- HUD: 上部にHP(%)とCost、Score。ダメージ時は赤フラッシュ＋揺れ。
- フィールド: パース付きグリッド。敵は炎アイコン、攻撃時はドクロ。HPバー表示。
- デッキ: 下部横スクロール。コスト不足でグレーアウト。選択中は浮き上がり。
- 緊急補給: 右上ボタン→全画面モーダルでクイズ表示。
- フィードバック: Hit/特効/減衰ポップアップ、設置時「設置」、攻撃到達時「BREAK!-xx」。

## 6. 技術スタック
- React 18（Hooks）、Vite、Tailwind CSS、lucide-reactアイコン。
- アニメーション: requestAnimationFrame 60fpsループ。
- 単一HTMLでのビルド配信を想定（GitHub Pages等）。

## 7. コードアーキテクチャ

### 7.1 プロジェクト構造
```
src/
├── components/
│   ├── Menu.jsx           (~30行)  - メニュー画面
│   ├── GameOver.jsx       (~15行)  - ゲームオーバー画面
│   ├── DraftPhase.jsx     (~60行)  - Phase 1: 現場診断フェーズ
│   ├── ExamPhase.jsx      (~70行)  - Phase 2: 予算獲得試験フェーズ
│   └── BattleField.jsx    (~240行) - Phase 3: バトル画面
└── App.jsx                (~560行) - メインロジックと状態管理
```

### 7.2 状態管理設計
- **App.jsx**: すべてのゲーム状態を一元管理（hp, cost, score, towers, enemies, etc.）
- **コンポーネント**: Propsベースの純粋なUIコンポーネント
- **ゲームループ**: `requestAnimationFrame`で60FPSのゲームロジック更新
- **Refs使用**: `towersRef`, `difficultyRef`でクロージャ問題を回避

### 7.3 コード品質保証
- **ESLint**: React/JSX推奨設定で静的解析
- **安全ガード**: NaN/Infinite対策、0除算防止
- **非ブロッキングUI**: window.confirm廃止、カスタムモーダル採用
- **ビルド最適化**: Viteによる高速ビルド（~3.7秒、167kB gzipped 55kB）

### 7.4 開発履歴

#### Phase 1: コード品質改善（緊急修正）
**実施日**: 2025-11-26
**コミット**: ae703ca

- ESLint設定追加（`.eslintrc.json`, `.eslintignore`）
- `window.confirm` → 非ブロッキングモーダルに置き換え
- `sizeSlow`安全ガード追加（0除算/NaN防止）
- Reactインポート最適化（JSX変換で不要なReactを削除）

**効果**: lint/buildエラー0、警告0達成

#### Phase 2: コンポーネント分割（Menu/Draft/Exam/GameOver）
**実施日**: 2025-11-26
**コミット**: 36328bc

**新規コンポーネント**:
- `Menu.jsx`: ミッション選択画面
- `GameOver.jsx`: ゲームオーバー画面
- `DraftPhase.jsx`: 現場診断フェーズ（lucide-reactアイコン含む）
- `ExamPhase.jsx`: 予算獲得試験フェーズ

**効果**:
- App.jsx: 922行 → 780行（-15%削減）
- コンポーネント数: 1 → 5
- 各画面の責務が明確化

#### Phase 3: BattleFieldコンポーネント分割（完了）
**実施日**: 2025-11-26
**コミット**: 13625ba

**新規コンポーネント**:
- `BattleField.jsx`: バトル画面全体（~240行）
  - グリッド、敵、タワー、エフェクト、デッキ、モーダルを含む
  - `RANGE_LABEL`, `GRID_ROWS`を内部定義

**効果**:
- App.jsx: 780行 → 560行（累計-39%削減）
- 最大ファイル行数: 922行 → 560行
- 保守性・テスタビリティの大幅向上

### 7.5 設計判断の記録

#### モノリシック状態管理の維持
**理由**: 小規模ゲームのため、Redux/Zustand等の状態管理ライブラリは導入せず、App.jsxで一元管理。

**利点**:
- シンプルな依存関係
- データフローが追いやすい
- オーバーヘッドなし

**欠点**:
- Props Drillingが深い（BattleFieldで20個のprops）
- 将来的な規模拡大時は状態管理ライブラリ検討が必要

#### コンポーネント分割基準
- **画面単位**: 各フェーズ（MENU/DRAFT/EXAM/BATTLE/GAMEOVER）を独立コンポーネント化
- **粒度**: 画面レベルまでで止め、過度な細分化は避ける
- **再利用性**: より汎用的なUIコンポーネント（ボタン、カード等）は現時点では未分割

## 8. 今後の拡張案

### ゲームプレイ拡張
- 状態異常: 煙による視界不良、注水によるクリア後評価減点
- 鑑別モード: 画像から器具名を答える実技対策ミニゲーム
- 編成/ガチャ: 報酬カードの収集とデッキ編成
- マルチライン/階層追加: 2F,3Fなどを増やし、延焼ルートを立体化

### 技術的改善
- **TypeScript移行**: 型安全性の向上
- **状態管理ライブラリ**: Zustand/Jotai等でProps Drilling解消
- **カスタムフック**: `useGameLoop`, `useEnemies`, `useTowers`への分離
- **定数ファイル分離**: `constants/cards.js`, `missions.js`, `questions.js`
- **ユニットテスト**: Vitest導入でゲームロジックのテスト
- **パフォーマンス最適化**: React.memo、useMemo、useCallbackの適用
